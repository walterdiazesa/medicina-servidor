name: Linode CI/CD

on:
  push:
    branches:
      - "main"

jobs:
  access-linode:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up SSH keys
        uses: webfactory/ssh-agent@v0.5.1
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Install sshpass
        run: sudo apt-get update && sudo apt-get install -y sshpass

      - name: Linode Commands
        run: |
          linode_ip="${{ secrets.LINODE_IP }}"
          linode_user="${{ secrets.LINODE_USER }}"
          linode_password="${{ secrets.LINODE_PASSWORD }}"

          sshpass -p "$linode_password" ssh "$linode_user"@"$linode_ip" '
            cd medicina-servidor/
            git pull
            pm2 restart flemik-node
          '
